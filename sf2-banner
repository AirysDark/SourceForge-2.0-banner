#!/usr/bin/env bash
set -euo pipefail

hr() { printf '%s\n' "$(printf '%*s' "$(tput cols 2>/dev/null || echo 40)" '' | tr ' ' 'â”€')"; }

print_header() {
  local datetime
  datetime="$(date '+%H:%M - %a %d/%m/%y')"
  hr
  echo " SourceForge 2.0 Banner : $datetime"
  hr
}

print_info() {
  echo "- Hostname: $(hostname)"
  echo "- Uptime: $(uptime -p)"
  ip=$(hostname -I 2>/dev/null | awk '{print $1}')
  echo "- LAN IP: ${ip:-N/A}"
  echo "- Load: $(awk '{print $1, $2, $3}' /proc/loadavg)"
  mem_total=$(free -h | awk '/Mem:/ {print $2}')
  mem_used=$(free -h | awk '/Mem:/ {print $3}')
  mem_perc=$(free | awk '/Mem:/ {printf "%.0f%%", $3/$2*100}')
  echo "- RAM: $mem_used / $mem_total ($mem_perc)"
  disk=$(df -h / | awk 'NR==2 {print $3 " / " $2 " (" $5 ")"}')
  echo "- Disk: $disk"
  hr
}

print_cmds() {
  echo
  echo " sf2-config           : Toggle banner plugins"
  echo " sf2-software         : Service/DB/DDNS/HTTPS menu"
  echo " sf2-banner --update  : Refresh banner + plugins"
  echo " htop                 : Resource monitor"
  echo " cpu                  : CPU info & stats"
  hr
}

if [[ \${1:-} == "--update" ]]; then
  echo "Updating banner..."
  git clone --depth=1 https://github.com/AirysDark/SourceForge-2.0-banner.git /tmp/sf2-banner-update
  sudo cp -a /tmp/sf2-banner-update/* /usr/lib/sf2/ || true
  rm -rf /tmp/sf2-banner-update
  exec sf2-banner
fi

print_header
print_info
print_cmds
