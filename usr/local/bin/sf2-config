#!/usr/bin/env bash
set -euo pipefail
AUTO="/usr/local/bin/sf2-banner"
_sf2_reload(){ [ -x "$AUTO" ] && "$AUTO" >/dev/null 2>&1 || (command -v sf2-banner >/dev/null 2>&1 && sf2-banner >/dev/null 2>&1) || true; }
trap _sf2_reload EXIT INT TERM

DIR="/usr/lib/sf2/banner.d"
mkdir -p "$DIR"
echo "Plugins in: $DIR"
i=1
declare -A MAP
shopt -s nullglob
for f in "$DIR"/*.sh; do
  base="$(basename "$f")"
  [ -x "$f" ] && st="ENABLED" || st="disabled"
  printf " %2d) %-24s [%s]\n" "$i" "$base" "$st"
  MAP[$i]="$f"
  i=$((i+1))
done
echo
read -rp "Toggle which # (q=quit): " pick || true
[[ "${pick:-q}" =~ ^[0-9]+$ ]] || exit 0
target="${MAP[$pick]:-}"
[ -n "$target" ] || exit 0
if [ -x "$target" ]; then chmod -x "$target" && echo "Disabled $(basename "$target")"
else chmod +x "$target" && echo "Enabled  $(basename "$target")"; fi

# Move the real tool aside (keep original intact)
sudo mv /usr/local/bin/sf2-config /usr/local/bin/.sf2-config-real

# New wrapper that: (a) elevates if needed, (b) runs real tool, (c) refreshes banner
sudo tee /usr/local/bin/sf2-config >/dev/null <<'WRAP'
#!/usr/bin/env bash
set -euo pipefail

# self-elevate if not root
if [ "${EUID:-$(id -u)}" -ne 0 ]; then
  exec sudo -E -- "$0" "$@"
fi

# run the real tool
/usr/local/bin/.sf2-config-real "$@"

# auto-reload banner on exit
if command -v /usr/local/bin/sf2-banner >/dev/null 2>&1; then
  /usr/local/bin/sf2-banner >/dev/null 2>&1 || true
fi
WRAP
sudo chmod 0755 /usr/local/bin/sf2-config